@(request: play.api.mvc.Request[Any])

@import helper._
@import helper.twitterBootstrap._

@main("mplayer") {
	<div class="pull-right" style="padding-right:5px;">
        <div class="btn-group">
            <button type="button" class="btn dropdown-toggle" data-toggle="dropdown">@request.session.get("username")  <span class="caret"></span></button>
            <ul class="dropdown-menu pull-right" role="menu">
                <li><a href="@routes.UserController.settingsPage(request.session.get("userid").getOrElse("-1").toLong)">Settings</a></li>
                <li class="divider"></li>
                <li><a href="@routes.UploadController.uploadPage">Upload a release</a></li>
                <li><a href="@routes.ManageController.genresPage">Manage music</a></li>
                <li class="divider"></li>
                <li><a href="@routes.AuthenticationController.logout">Logout</a></li>
            </ul>
        </div>
	</div>
	<div id="jplayer"></div>
	<div id="jp_container_1" style="width:100%;">
        <div class="controls controls-row">
    		<div class="pull-left" style="padding-right:5px;">
    			<a href="#" class="btn btn-success btn-mini jp-play">&#9658;</a>
    			<a href="#" class="btn btn-success btn-mini jp-pause">| |</a>
    		</div>
    		<div class="pull-left" style="padding-right:5px;">
    			<p id="nowplaying"></p>
    		</div>
    		<div class="pull-right" style="padding-right:20px;">
    			<input type="text" class="span2" id="volume" data-slider-min="0" data-slider-max="100" data-slider-value="50" data-slider-tooltip="hide" data-slider-id="volume">
    		</div>
        </div>
        <div class="controls controls-row" id="seekdiv" style="width:99%;">
            <div class="progress active">
                <div class="progress-bar progress-bar-success active" id="seek"></div>
            </div>
        </div>
	</div>
	<br><br>

	<div style="position:absolute;top:70px;left:0;height:300px;width:100%;">
		<ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
	        <li class="active"><a href="#genres" data-toggle="tab">Genres</a></li>
	        <li><a href="#artists" data-toggle="tab">Artists</a></li>
	        <li><a href="#albums" data-toggle="tab">Albums</a></li>
	        <li><a href="#countries" data-toggle="tab">Countries</a></li>
	    </ul>
	    <div id="my-tab-content" class="tab-content" style="overflow:auto;position:absolute;top:20;left:0;height:300px;width:100%;">
	        <div class="tab-pane active" id="genres">
	            <table class="table table-hover table-condensed table-striped compact" id="genrestable"></table>
	        </div>
	        <div class="tab-pane" id="artists">
	            <table class="table table-hover table-condensed table-striped compact" id="artiststable"><th>Nothing to show</th></table>
	        </div>
	        <div class="tab-pane" id="albums">
	            <table class="table table-hover table-condensed table-striped compact" id="albumstable"><th>Nothing to show</th></table>
	        </div>
	        <div class="tab-pane" id="countries">
	            <table class="table table-hover table-condensed table-striped compact" id="countriestable"><th>Nothing to show</th></table>
	        </div>
	    </div>
	</div>
	<hr>
	<div id="tracksholder" style="overflow:auto;position:absolute;top:440px;left:0;right:0;bottom:0px;">
		<b>Playlist</b>
		<table id="trackstable" class="table table-hover table-striped compact">
			<th>Nothing to show</th>
		</table>
	</div>

	<script type="text/javascript">
		var currentId = 0;
        var currentGenre = "";
        var currentArtist = "";
        var currentCountry = "";
        var currentAlbum = "";
        var currentYear = 0;
        var currentTrack = "";
        var currentDuration = "";
        var currentTimestamp = 0;

        var currentTime = 0;

	    $(document).ready(function(){
	        $("#jplayer").jPlayer();

	        $('#volume').slider({
	            formater: function(value) {
	                $("#jplayer").jPlayer("volume", value/100);
	                return 'Volume: ' + value;
	            }
	        });

            // initSeekSlider();

	        $("#tabs").tab();
	        fillGenres();
	        fillCountries();

	        $(function() {
				$.extend($.fn.disableTextSelect = function() {
					return this.each(function() {
						$(this).mousedown(function() { return false; });
					});
				});
			});
	    });

	    function updatePlayer(id){
            var player = $("#jplayer");

            player.jPlayer({
            ready: function () { 
                $(this).jPlayer("setMedia", { 
                    mp3: "get?id=" + id
                }); 
                $(this).jPlayer("play");
            },
            swfPath: "/js",
            supplied: "mp3",
            }); 
            player.jPlayer("setMedia", { 
                mp3: "get?id=" + id
            }); 
            player.jPlayer("play");
            player.bind($.jPlayer.event.ended, function(event) {
                console.log("song ended");
                scrobble(currentArtist, currentTrack, currentTimestamp);
                playNext();
            });
            player.bind($.jPlayer.event.timeupdate, function(event) {
                // changeSeekValue($('#jplayer').data('jPlayer').status.currentTime, $('#jplayer').data('jPlayer').status.duration)
            });

            updateTrackInfo(id);
        }

        // function initSeekSlider() {
        //     $('#seek').on('slideStop', function(event) {
        //         $("#jplayer").jPlayer("playHead", parseInt(event.value * 0.95));
        //         console.log('Seek: ' + parseInt(event.value * 0.95));
        //     });
        //     //$('#seek').css('width', '99%');
        // }

        // function changeSeekValue(current, total) {
        //     var now = parseInt((current/total) * 100, 10);
        //     if (now != currentTime) {
        //         currentTime = now;
        //         $('#seek').attr('aria-valuenow', parseInt((current/total) * 100, 10));
        //         // $('#seek').remove();
        //         // $('#seekdiv').after('<div style="padding-right:20px;padding-left:20px;width:100%;">                <input type="text" id="seek" data-slider-min="0" data-slider-max="100" data-slider-value="' + parseInt((current/total) * 100, 10) + '" data-slider-tooltip="hide" data-slider-id="seek" style="width:100%;">            </div>');
        //         // initSeekSlider();
        //     }
        // }

        function updateTrackInfo(id) {
            $.getJSON("/trackinfo?id=" + id, function(json) {
                var nowplaying = $("#nowplaying");
                currentId = id;
                currentGenre = json.album.artist.genre.name;
                currentArtist = json.album.artist.name;
                if (json.album.artist.country != undefined) {
                	currentCountry = json.album.artist.country.name;
            	}
                currentAlbum = json.album.name;
                currentYear = json.album.year;
                currentTrack = json.name;
                currentDuration = json.duration;
                currentTimestamp = Math.round(+new Date()/1000);
                nowplaying.text(currentArtist + " - " + currentTrack + " (" + currentDuration + ")");
                updateNowPlaying(currentArtist, currentTrack);
                return false;
            });
        }

	    function updateNowPlaying(artist, track) {
	    	$("#currentartist").text(artist);
            $.getJSON("/updatenowplaying?artist=" + artist + "&track=" + track + "&userid=" + @request.session.get("userid").getOrElse("-1").toLong, function(json) {
                return false;
            });
        }

        function scrobble(artist, track, timestamp) {
        	$.getJSON("/scrobble?artist=" + artist + "&track=" + track + "&timestamp=" + timestamp + "&userid=" + @request.session.get("userid").getOrElse("-1").toLong, function(json) {
                return false;
            });	
        }

        function fillGenres() {
            $.getJSON("/genres", function(json) {
                var table = $("#genrestable");
                table.empty();
                highlightOnClick(table);
                $.each(json, function() {
                    var tbl_row = $("<tr>", {class: "loadartists", href: "#artists", id: this.id});
                    var tbl_cell = $("<td>", {id: this.id, html: this.name});
                    tbl_row.append(tbl_cell);
                    var id = this.id;
                    setClickHandlers(tbl_row, function() {
                        fillArtists("/artists?genreid=" + id);
                    }, function() {
                        $.getJSON("/tracks?genreid=" + id, function(json) {
                            console.log("/tracks?genreid=" + id);
                            fillTracks(json);
                        });
                    });
                    table.append(tbl_row);
                })
                return false;
            });
        }

        function fillCountries() {
            $.getJSON("/countries", function(json) {
                var table = $("#countriestable");
                table.empty();
                highlightOnClick(table);
                $.each(json, function() {
                    var tbl_row = $("<tr>", {class: "loadartists", href: "#artists", id: this.id});
                    var tbl_cell = $("<td>", {id: this.id, html: this.name});
                    tbl_row.append(tbl_cell);
                    var id = this.id;
                    setClickHandlers(tbl_row, function() {
                        fillArtists("/artists?countryid=" + id);
                    }, function() {
                        $.getJSON("/tracks?countryid=" + id, function(json) {
                            console.log("/tracks?countryid=" + id);
                            fillTracks(json);
                        });
                    });
                    table.append(tbl_row);
                })
                return false;
            });
        }

        function fillArtists(url) {
            console.log(url);
            $.getJSON(url, function(json) {
                var table = $("#artiststable");
                table.empty();
                headers(table, ["Name"]);
                highlightOnClick(table);
                $.each(json, function() {
                    var tbl_row = $("<tr>", {href: "#", class: "loadalbums", id: this.id});
                    var tbl_cell = $("<td>", {id: this.id, html: this.name});
                    tbl_row.append(tbl_cell);
                    var id = this.id;
                    setClickHandlers(tbl_row, function() {
                        fillAlbums(id);
                    }, function() {
                        $.getJSON("/tracks?artistid=" + id, function(json) {
                            console.log("/tracks?artistid=" + id);
                            fillTracks(json);
                        });
                    });
                    table.append(tbl_row);
                })
                $('#tabs a[href="#artists"]').tab('show');
                return false;
            });
        }

        function fillAlbums(artistid) {
            console.log("/albums?artistid=" + artistid);
            $.getJSON("/albums?artistid=" + artistid, function(json) {
                var table = $("#albumstable");
                table.empty();
                headers(table, ["Year", "Name", "Format"]);
                highlightOnClick(table);
                $.each(json, function() {
                    var tbl_row = $("<tr>", {href: "#", class: "loadtracks", id: this.id});
                    var tbl_cell_year = $("<td>", {id: this.id, html: this.year});
                    var tbl_cell_name = $("<td>", {id: this.id, html: this.name});
                    var tbl_cell_format = $("<td>", {id: this.id, html: this.format});
                    tbl_row.append(tbl_cell_year);
                    tbl_row.append(tbl_cell_name);
                    tbl_row.append(tbl_cell_format);
                    var id = this.id;
                    setClickHandlers(tbl_row, function() {
                        $.getJSON("/tracks?albumid=" + id, function(json) {
                            console.log("/tracks?albumid=" + id);
                            fillTracks(json);
                        });
                    }, function() {
                        alert("Double click");
                    });
                    table.append(tbl_row);
                })
                $('#tabs a[href="#albums"]').tab('show');
                return false;
            });
        }

        function fillTracks(json) {
            var table = $("#trackstable");
            table.empty();
            headers(table, ["#", "Title", "Duration", "Artist", "Country", "Album", "Year", "Genre"]);
            highlightOnClick(table);
            var count = 1;
            $.each(json, function() {
                var tbl_row = $("<tr>", {class: "play", href: "#", id: this.id});
                var tbl_cell_no = $("<td>", {id: this.id, html: count++});
                var tbl_cell_name = $("<td>", {id: this.id, html: this.name});
                var tbl_cell_duration = $("<td>", {id: this.id, html: this.duration});
                var tbl_cell_artist = $("<td>", {id: this.id, html: this.album.artist.name});
                var country = this.album.artist.country;
                if (country != undefined) {
                    var tbl_cell_country = $("<td>", {id: this.id, html: this.album.artist.country.name});
                } else {
                    var tbl_cell_country = $("<td>", {id: this.id, html: "-"});
                }
                var tbl_cell_album = $("<td>", {id: this.id, html: this.album.name});
                var tbl_cell_year = $("<td>", {id: this.id, html: this.album.year});
                var tbl_cell_genre = $("<td>", {id: this.id, html: this.album.artist.genre.name});
                tbl_row.append(tbl_cell_no);
                tbl_row.append(tbl_cell_name);
                tbl_row.append(tbl_cell_duration);
                tbl_row.append(tbl_cell_artist);
                tbl_row.append(tbl_cell_country);
                tbl_row.append(tbl_cell_album);
                tbl_row.append(tbl_cell_year);
                tbl_row.append(tbl_cell_genre);
                tbl_row.click(function(event) {
                    id = event.target.id
                    console.log("get?id=" + id)
                    updatePlayer(id)
                });
                table.append(tbl_row);
            });
            return false;
        }
    </script>
}
